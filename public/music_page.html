<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Symbols Animation</title>
    <link rel="stylesheet" href="music_style.css">
</head>
<body>
    <!-- Welcome Message -->
    <div id="welcome-message" class="welcome-text">
        Welcome to our Music World!
    </div>

    <!-- Music Symbols Container -->
    <div id="music-symbols-container" class="symbols-container">
        <!-- Music symbols will be generated by JavaScript -->
    </div>

    <!-- Back to Home Link -->
    <a href="https://thestrokes1.github.io/Portfolio-Cristian/" class="back-link">‚Üê Back to Home</a>

    <!-- Combined URL Manager & Controls Panel -->
    <div id="unified-manager" class="unified-manager">
        <!-- Collapsible Header with Toggle Button -->
        <div class="manager-header">
            <h3>üéµ Music Control Center</h3>
            <button id="toggle-manager" class="toggle-btn">
                <span class="toggle-icon">‚ñº</span>
            </button>
        </div>
        
        <!-- Always Visible URL Input Section -->
        <div class="always-visible-section">
            <div class="url-input-container">
                <input type="url" id="url-input" placeholder="Enter URL to add...">
                <button id="add-url-btn" class="add-url-btn">Add URL</button>
            </div>
        </div>
        
        <!-- Collapsible Content Section -->
        <div id="manager-content" class="manager-content">
            <!-- Statistics Section -->
            <div class="stats-section">
                <div class="stat-item">
                    <span class="stat-label">URLs in Pool:</span>
                    <span id="url-count" class="stat-value">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Green Symbols:</span>
                    <span id="assigned-count" class="stat-value">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Available:</span>
                    <span id="available-count" class="stat-value">0</span>
                </div>
            </div>
            
            <!-- Admin Status Indicator -->
            <div id="admin-status" class="admin-status" style="display: none;">
                <span class="admin-crown">üëë</span>
                <span class="admin-text">ADMIN</span>
            </div>
            
            <!-- Control Buttons Section -->
            <div class="control-buttons-section">
                <button id="save-btn" class="control-btn save-btn">
                    <span class="btn-icon">üíæ</span>
                    <span class="btn-text">Save Symbols</span>
                </button>
                <button id="restore-btn" class="control-btn restore-btn">
                    <span class="btn-icon">üîÑ</span>
                    <span class="btn-text">Restore All</span>
                </button>
                <button id="music-login-btn" class="control-btn login-btn" style="display: none;">
                    <span class="btn-icon">üîë</span>
                    <span class="btn-text">Login</span>
                </button>
                <button id="music-logout-btn" class="control-btn logout-btn">
                    <span class="btn-icon">üö™</span>
                    <span class="btn-text">Logout</span>
                </button>
            </div>
            
            <!-- Admin Panel Section -->
            <div id="admin-panel" class="admin-panel" style="display: none;">
                <div class="admin-header">
                    <h4>üîß Admin Controls</h4>
                </div>
                <div class="admin-controls">
                    <button id="admin-view-urls-btn" class="control-btn admin-btn">
                        <span class="btn-icon">üåç</span>
                        <span class="btn-text">View URLs</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div id="auth-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-modal" id="auth-close">&times;</span>
            <h2 id="auth-title">Login</h2>
            
            <!-- Login Form -->
            <div id="login-form" class="auth-form">
                <div class="form-group">
                    <label for="login-username">Username:</label>
                    <input type="text" id="login-username" placeholder="Enter username" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password:</label>
                    <input type="password" id="login-password" placeholder="Enter password" required>
                </div>
                <button type="button" id="login-btn" class="auth-btn">Login</button>
                <div class="auth-switch">
                    <p>Don't have an account? <a href="#" id="show-register">Register here</a></p>
                </div>
            </div>
            
            <!-- Registration Form -->
            <div id="register-form" class="auth-form" style="display: none;">
                <div class="form-group">
                    <label for="register-username">Username:</label>
                    <input type="text" id="register-username" placeholder="Choose username (min 3 chars)" required>
                </div>
                <div class="form-group">
                    <label for="register-password">Password:</label>
                    <input type="password" id="register-password" placeholder="Choose password (min 6 chars)" required>
                </div>
                <div class="form-group">
                    <label for="register-confirm">Confirm Password:</label>
                    <input type="password" id="register-confirm" placeholder="Confirm password" required>
                </div>
                <button type="button" id="register-btn" class="auth-btn">Register</button>
                <div class="auth-switch">
                    <p>Already have an account? <a href="#" id="show-login">Login here</a></p>
                </div>
            </div>
            
            <!-- User Status (when logged in) -->
            <div id="user-status" class="auth-form" style="display: none;">
                <div class="user-info">
                    <h3>Welcome, <span id="current-username"></span>!</h3>
                    <p>You are now logged in and can add URLs to symbols.</p>
                    <p style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 10px;">Use the logout button in the control panel to sign out.</p>
                </div>
            </div>
            
            <!-- Error/Success Messages -->
            <div id="auth-message" class="auth-message"></div>
        </div>
    </div>

    <!-- Admin URLs Management Modal -->
    <div id="admin-urls-modal" class="admin-modal" style="display: none;">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h2>üåç Global URL Pool Management</h2>
                <span class="admin-close" id="admin-urls-close">&times;</span>
            </div>
            
            <div class="admin-modal-body">
                <!-- Admin URLs Stats -->
                <div class="admin-urls-stats">
                    <p><strong>üë• Created By:</strong> Shows which user added each URL</p>
                    <p><strong>üîó Total URLs:</strong> <span id="admin-total-urls">0</span></p>
                    <p><strong>üóëÔ∏è Delete:</strong> Removes URL for ALL users</p>
                </div>
                
                <!-- Admin URLs Actions -->
                <div class="admin-urls-actions">
                    <button id="admin-refresh-urls" class="admin-refresh-btn">
                        <span class="btn-icon">üîÑ</span>
                        <span class="btn-text">Refresh</span>
                    </button>
                    <button id="admin-delete-all-btn" class="admin-delete-all-btn">
                        <span class="btn-icon">üóëÔ∏è</span>
                        <span class="btn-text">Delete All URLs</span>
                    </button>
                </div>
                
                <!-- Admin URLs List -->
                <div class="admin-urls-list" id="admin-urls-list">
                    <!-- URLs will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Authentication Modal JavaScript -->
    <script>
    class AuthModal {
        constructor() {
            this.modal = document.getElementById('auth-modal');
            this.closeBtn = document.getElementById('auth-close');
            this.loginForm = document.getElementById('login-form');
            this.registerForm = document.getElementById('register-form');
            this.userStatus = document.getElementById('user-status');
            this.authTitle = document.getElementById('auth-title');
            this.authMessage = document.getElementById('auth-message');
            this.currentUsername = document.getElementById('current-username');
            
            this.token = localStorage.getItem('authToken');
            this.username = localStorage.getItem('username');
            
            this.initEventListeners();
            this.checkAuthStatus();
        }
        
        initEventListeners() {
            this.closeBtn.addEventListener('click', () => this.hide());
            this.modal.addEventListener('click', (e) => {
                if (e.target === this.modal) this.hide();
            });
            
            document.getElementById('show-register').addEventListener('click', (e) => {
                e.preventDefault();
                this.showRegister();
            });
            
            document.getElementById('show-login').addEventListener('click', (e) => {
                e.preventDefault();
                this.showLogin();
            });
            
            document.getElementById('login-btn').addEventListener('click', () => this.login());
            document.getElementById('register-btn').addEventListener('click', () => this.register());
            
            ['login-username', 'login-password', 'register-username', 'register-password', 'register-confirm'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            if (id.includes('login')) this.login();
                            else this.register();
                        }
                    });
                }
            });
        }
        
        show() {
            this.modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        hide() {
            this.modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            this.clearMessages();
        }
        
        showLogin() {
            this.loginForm.style.display = 'block';
            this.registerForm.style.display = 'none';
            this.userStatus.style.display = 'none';
            this.authTitle.textContent = 'Login';
            this.clearMessages();
        }
        
        showRegister() {
            this.loginForm.style.display = 'none';
            this.registerForm.style.display = 'block';
            this.userStatus.style.display = 'none';
            this.authTitle.textContent = 'Register';
            this.clearMessages();
        }
        
        showUserStatus() {
            this.loginForm.style.display = 'none';
            this.registerForm.style.display = 'none';
            this.userStatus.style.display = 'block';
            this.authTitle.textContent = 'Account';
            this.currentUsername.textContent = this.username;
            this.clearMessages();
        }
        
        showMessage(message, type = 'success') {
            this.authMessage.textContent = message;
            this.authMessage.className = `auth-message ${type}`;
            this.authMessage.style.display = 'block';
            
            setTimeout(() => {
                this.clearMessages();
            }, 5000);
        }
        
        clearMessages() {
            this.authMessage.style.display = 'none';
            this.authMessage.textContent = '';
            this.authMessage.className = 'auth-message';
        }
        
        setLoading(button, loading) {
            if (loading) {
                button.classList.add('loading');
                button.disabled = true;
            } else {
                button.classList.remove('loading');
                button.disabled = false;
            }
        }
        
        async login() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            const loginBtn = document.getElementById('login-btn');
            
            if (!username || !password) {
                this.showMessage('Please enter both username and password', 'error');
                return;
            }
            
            this.setLoading(loginBtn, true);
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Login failed');
                }
                
                const data = await response.json();
                
                if (response.ok) {
                    this.token = data.token;
                    this.username = data.user ? data.user.username : data.username;
                    
                    localStorage.setItem('authToken', this.token);
                    localStorage.setItem('username', this.username);
                    
                    this.showMessage('Login successful!', 'success');
                    this.checkAuthStatus();
                    
                    setTimeout(() => {
                        this.hide();
                        if (window.musicPage) {
                            window.musicPage.onUserLogin();
                        }
                    }, 1000);
                } else {
                    this.showMessage(data.error || 'Login failed', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                this.showMessage('Login failed. Please try again.', 'error');
            } finally {
                this.setLoading(loginBtn, false);
            }
        }
        
        async register() {
            const username = document.getElementById('register-username').value.trim();
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm').value;
            const registerBtn = document.getElementById('register-btn');
            
            if (!username || !password || !confirmPassword) {
                this.showMessage('Please fill in all fields', 'error');
                return;
            }
            
            if (username.length < 3) {
                this.showMessage('Username must be at least 3 characters', 'error');
                return;
            }
            
            if (password.length < 6) {
                this.showMessage('Password must be at least 6 characters', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                this.showMessage('Passwords do not match', 'error');
                return;
            }
            
            this.setLoading(registerBtn, true);
            
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Registration failed');
                }
                
                const data = await response.json();
                
                if (response.ok) {
                    this.token = data.token;
                    this.username = data.user ? data.user.username : data.username;
                    
                    localStorage.setItem('authToken', this.token);
                    localStorage.setItem('username', this.username);
                    
                    this.showMessage('Registration successful!', 'success');
                    this.checkAuthStatus();
                    
                    setTimeout(() => {
                        this.hide();
                        if (window.musicPage) {
                            window.musicPage.onUserLogin();
                        }
                    }, 1000);
                } else {
                    this.showMessage(data.error || 'Registration failed', 'error');
                }
            } catch (error) {
                console.error('Registration error:', error);
                this.showMessage('Registration failed. Please try again.', 'error');
            } finally {
                this.setLoading(registerBtn, false);
            }
        }
        
        logout() {
            this.token = null;
            this.username = null;
            
            localStorage.removeItem('authToken');
            localStorage.removeItem('username');
            
            this.showMessage('Logged out successfully', 'success');
            
            setTimeout(() => {
                this.hide();
                this.checkAuthStatus();
                if (window.musicPage) {
                    window.musicPage.onUserLogout();
                }
            }, 1000);
        }
        
        checkAuthStatus() {
            if (this.token && this.username) {
                this.showUserStatus();
            } else {
                this.showLogin();
            }
        }
        
        isAuthenticated() {
            return !!this.token;
        }
        
        getAuthData() {
            return {
                token: this.token,
                username: this.username
            };
        }
    }

    class AdminURLsModal {
        constructor() {
            this.modal = document.getElementById('admin-urls-modal');
            this.closeBtn = document.getElementById('admin-urls-close');
            this.urlsList = document.getElementById('admin-urls-list');
            this.totalUrlsSpan = document.getElementById('admin-total-urls');
            this.refreshBtn = document.getElementById('admin-refresh-urls');
            this.deleteAllBtn = document.getElementById('admin-delete-all-btn');
            
            this.initEventListeners();
        }
        
        initEventListeners() {
            this.closeBtn.addEventListener('click', () => this.hide());
            this.modal.addEventListener('click', (e) => {
                if (e.target === this.modal) this.hide();
            });
            
            this.refreshBtn.addEventListener('click', () => this.loadURLs());
            this.deleteAllBtn.addEventListener('click', () => this.deleteAllURLs());
        }
        
        show() {
            this.modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            this.loadURLs();
        }
        
        hide() {
            this.modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        async loadURLs() {
            this.setLoading(true);
            
            try {
                const authData = window.authModal.getAuthData();
                
                const response = await fetch('/api/admin/urls', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authData.token}`
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to load URLs');
                }
                
                const data = await response.json();
                
                this.displayURLs(data.urls || []);
                this.updateTotalCount(data.urls ? data.urls.length : 0);
                
            } catch (error) {
                console.error('Error loading URLs:', error);
                this.displayError('Failed to load URLs. Please try again.');
            } finally {
                this.setLoading(false);
            }
        }
        
        displayURLs(urls) {
            this.urlsList.innerHTML = '';
            
            if (!urls || urls.length === 0) {
                this.urlsList.innerHTML = '<div class="admin-empty-state">No URLs found in the pool</div>';
                return;
            }
            
            urls.forEach((urlData, index) => {
                const urlItem = this.createURLItem(urlData, index);
                this.urlsList.appendChild(urlItem);
            });
        }
        
        createURLItem(urlData, index) {
            const item = document.createElement('div');
            item.className = 'admin-url-item';
            
            const details = document.createElement('div');
            details.className = 'admin-url-details';
            
            const urlText = document.createElement('div');
            urlText.className = 'admin-url-text';
            urlText.textContent = urlData.url;
            
            const meta = document.createElement('div');
            meta.className = 'admin-url-meta';
            meta.innerHTML = `
                <span class="admin-url-id">ID: ${urlData.id}</span>
                <span class="admin-url-creator">Created by: ${urlData.created_by || 'Unknown'}</span>
                ${urlData.created_at ? ` ‚Ä¢ Added: ${new Date(urlData.created_at).toLocaleDateString()}` : ''}
            `;
            
            details.appendChild(urlText);
            details.appendChild(meta);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'admin-url-delete-btn';
            deleteBtn.innerHTML = '‚úï';
            deleteBtn.title = 'Delete this URL';
            deleteBtn.addEventListener('click', () => this.deleteURL(urlData, deleteBtn));
            
            item.appendChild(details);
            item.appendChild(deleteBtn);
            
            return item;
        }
        
        async deleteURL(urlData, button) {
            if (!confirm(`Are you sure you want to delete this URL?\n\n${urlData.url}\n\nThis will remove it for ALL users.`)) {
                return;
            }
            
            this.setDeleteButtonLoading(button, true);
            
            try {
                const authData = window.authModal.getAuthData();
                
                const response = await fetch(`/api/urls/${urlData.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authData.token}`
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to delete URL');
                }
                
                // Remove the item from the list
                button.closest('.admin-url-item').style.opacity = '0';
                button.closest('.admin-url-item').style.transform = 'translateX(-20px)';
                
                setTimeout(() => {
                    button.closest('.admin-url-item').remove();
                    this.updateTotalCount(this.urlsList.querySelectorAll('.admin-url-item').length);
                    
                    if (this.urlsList.children.length === 0) {
                        this.urlsList.innerHTML = '<div class="admin-empty-state">No URLs found in the pool</div>';
                    }
                }, 300);
                
                // Update the main page URL count
                if (window.musicPage) {
                    window.musicPage.updateURLCount();
                }
                
            } catch (error) {
                console.error('Error deleting URL:', error);
                alert('Failed to delete URL. Please try again.');
            } finally {
                this.setDeleteButtonLoading(button, false);
            }
        }
        
        async deleteAllURLs() {
            const itemCount = this.urlsList.querySelectorAll('.admin-url-item').length;
            
            if (itemCount === 0) {
                alert('No URLs to delete.');
                return;
            }
            
            if (!confirm(`‚ö†Ô∏è DANGER: Are you sure you want to delete ALL ${itemCount} URLs?\n\nThis will affect ALL users and cannot be undone.\n\nType "DELETE ALL" to confirm:`)) {
                return;
            }
            
            const confirmation = prompt('Type "DELETE ALL" to confirm:');
            if (confirmation !== 'DELETE ALL') {
                alert('Deletion cancelled - confirmation text did not match.');
                return;
            }
            
            this.setLoading(true);
            
            try {
                const authData = window.authModal.getAuthData();
                
                const response = await fetch('/api/admin/clear-all-urls', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authData.token}`
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to delete all URLs');
                }
                
                // Clear the list
                this.urlsList.innerHTML = '<div class="admin-empty-state">No URLs found in the pool</div>';
                this.updateTotalCount(0);
                
                // Update the main page
                if (window.musicPage) {
                    window.musicPage.updateURLCount();
                }
                
                alert(`‚úÖ ALL URLs have been cleared by admin! This affects ALL users.`);
                
            } catch (error) {
                console.error('Error deleting all URLs:', error);
                alert('Failed to delete all URLs. Please try again.');
            } finally {
                this.setLoading(false);
            }
        }
        
        updateTotalCount(count) {
            this.totalUrlsSpan.textContent = count;
        }
        
        displayError(message) {
            this.urlsList.innerHTML = `<div class="admin-empty-state" style="color: #ff6b6b;">${message}</div>`;
        }
        
        setLoading(loading) {
            if (loading) {
                this.refreshBtn.disabled = true;
                this.refreshBtn.innerHTML = '<span class="btn-icon">‚è≥</span><span class="btn-text">Loading...</span>';
                this.deleteAllBtn.disabled = true;
            } else {
                this.refreshBtn.disabled = false;
                this.refreshBtn.innerHTML = '<span class="btn-icon">üîÑ</span><span class="btn-text">Refresh</span>';
                this.deleteAllBtn.disabled = false;
            }
        }
        
        setDeleteButtonLoading(button, loading) {
            if (loading) {
                button.disabled = true;
                button.innerHTML = '‚è≥';
            } else {
                button.disabled = false;
                button.innerHTML = '‚úï';
            }
        }
    }

    // Initialize authentication modal when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        window.authModal = new AuthModal();
        window.adminURLsModal = new AdminURLsModal();
        
        // Initialize music page auth controls
        const musicLoginBtn = document.getElementById('music-login-btn');
        const musicLogoutBtn = document.getElementById('music-logout-btn');
        const viewURLsBtn = document.getElementById('admin-view-urls-btn');
        
        // Add click event for login button
        if (musicLoginBtn) {
            musicLoginBtn.addEventListener('click', () => {
                window.authModal.show();
            });
        }
        
        // Add click event for logout button
        if (musicLogoutBtn) {
            musicLogoutBtn.addEventListener('click', () => {
                window.authModal.logout();
            });
        }
        
        // Add click event for View URLs button
        if (viewURLsBtn) {
            viewURLsBtn.addEventListener('click', () => {
                window.adminURLsModal.show();
            });
        }
        
        // Update button visibility on auth status change
        const originalCheckAuthStatus = window.authModal.checkAuthStatus.bind(window.authModal);
        window.authModal.checkAuthStatus = function() {
            originalCheckAuthStatus();
            updateAuthButtons();
        };
        
        // Update auth buttons visibility
        function updateAuthButtons() {
            const loginBtn = document.getElementById('music-login-btn');
            const logoutBtn = document.getElementById('music-logout-btn');
            
            if (window.authModal.isAuthenticated()) {
                if (loginBtn) loginBtn.style.display = 'none';
                if (logoutBtn) logoutBtn.style.display = 'inline-block';
            } else {
                if (loginBtn) loginBtn.style.display = 'inline-block';
                if (logoutBtn) logoutBtn.style.display = 'none';
            }
        }
        
        // Initial button update
        updateAuthButtons();
        
        // Override onUserLogin and onUserLogout to update buttons
        const originalOnUserLogin = window.authModal.onUserLogin || (() => {});
        const originalOnUserLogout = window.authModal.onUserLogout || (() => {});
        
        window.authModal.onUserLogin = function() {
            originalOnUserLogin.call(this);
            updateAuthButtons();
        };
        
        window.authModal.onUserLogout = function() {
            originalOnUserLogout.call(this);
            updateAuthButtons();
        };
        
        // Unified Manager Toggle Functionality
        initializeUnifiedManager();
    });

    // Initialize the unified manager collapsible functionality
    function initializeUnifiedManager() {
        const toggleBtn = document.getElementById('toggle-manager');
        const managerContent = document.getElementById('manager-content');
        const toggleIcon = toggleBtn.querySelector('.toggle-icon');
        
        if (toggleBtn && managerContent && toggleIcon) {
            let isExpanded = false; // Start collapsed
            
            toggleBtn.addEventListener('click', function() {
                isExpanded = !isExpanded;
                
                if (isExpanded) {
                    managerContent.style.display = 'block';
                    managerContent.style.maxHeight = managerContent.scrollHeight + 'px';
                    toggleIcon.textContent = '‚ñº';
                } else {
                    managerContent.style.maxHeight = '0';
                    managerContent.style.display = 'none';
                    toggleIcon.textContent = '‚ñ≤';
                }
            });
            
            // Set initial state (collapsed)
            managerContent.style.maxHeight = '0';
            managerContent.style.display = 'none';
            toggleIcon.textContent = '‚ñ≤';
        }
    }
    </script>

    <script src="music_script.js"></script>
</body>
</html>
